<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>To-Do App</title>
    <style>
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica,
          Arial, sans-serif;
        margin: 24px;
      }
      h1 {
        margin: 0 0 16px;
      }
      form {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
      }
      input {
        flex: 1 1 auto;
        padding: 8px 10px;
      }
      button {
        padding: 8px 12px;
        cursor: pointer;
      }
      ul {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        gap: 8px;
      }
      li {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
      }
      .empty {
        color: #777;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <h1>To-Do</h1>
    <section id="auth">
      <form id="auth-form">
        <input
          id="username"
          placeholder="Username"
          aria-label="Username"
          required
        />
        <input
          id="password"
          type="password"
          placeholder="Password"
          aria-label="Password"
          required
        />
        <button id="login-btn" type="button">Login</button>
        <button id="signup-btn" type="button">Sign Up</button>
      </form>
      <p id="auth-status" class="empty"></p>
    </section>
    <form id="todo-form">
      <input
        id="todo-input"
        placeholder="Add a task"
        aria-label="New todo"
        required
      />
      <button type="submit">Add</button>
    </form>
    <ul id="todo-list"></ul>
    <template id="todo-item-template">
      <li>
        <span class="text"></span>
        <button class="delete" aria-label="Delete">Delete</button>
      </li>
    </template>
    <script>
      const API = "http://localhost:3000";
      const list = document.getElementById("todo-list");
      const form = document.getElementById("todo-form");
      const input = document.getElementById("todo-input");
      const tpl = document.getElementById("todo-item-template");
      const username = document.getElementById("username");
      const password = document.getElementById("password");
      const loginBtn = document.getElementById("login-btn");
      const signupBtn = document.getElementById("signup-btn");
      const authStatus = document.getElementById("auth-status");

      let token = localStorage.getItem("token") || "";

      function setToken(newToken, user) {
        token = newToken;
        if (newToken) {
          localStorage.setItem("token", newToken);
          authStatus.textContent = `Signed in as ${user}`;
        } else {
          localStorage.removeItem("token");
          authStatus.textContent = "Not signed in";
        }
      }

      async function loadTodos() {
        try {
          const res = await fetch(API + "/todos", {
            headers: token ? { Authorization: `Bearer ${token}` } : {},
          });
          const todos = await res.json();
          renderTodos(todos);
        } catch (e) {
          console.error(e);
          list.innerHTML =
            '<li class="empty">Could not load todos. Is the server running on 3000?</li>';
        }
      }

      function renderTodos(todos) {
        list.innerHTML = "";
        if (!todos.length) {
          list.innerHTML = '<li class="empty">No todos yet</li>';
          return;
        }
        todos.forEach((todo) => {
          const node = tpl.content.firstElementChild.cloneNode(true);
          node.querySelector(".text").textContent = todo.text;
          node.querySelector(".delete").addEventListener("click", async () => {
            await fetch(API + "/todos/" + todo.id, {
              method: "DELETE",
              headers: token ? { Authorization: `Bearer ${token}` } : {},
            });
            loadTodos();
          });
          list.appendChild(node);
        });
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const text = input.value.trim();
        if (!text) return;
        await fetch(API + "/todos", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...(token ? { Authorization: `Bearer ${token}` } : {}),
          },
          body: JSON.stringify({ text }),
        });
        input.value = "";
        loadTodos();
      });

      loginBtn.addEventListener("click", async () => {
        try {
          const res = await fetch(API + "/auth/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              username: username.value.trim(),
              password: password.value,
            }),
          });
          if (!res.ok) {
            const msg = await res.json().catch(() => ({}));
            throw new Error(msg.message || "Login failed");
          }
          const data = await res.json();
          setToken(data.token, data.username);
          loadTodos();
        } catch (err) {
          authStatus.textContent = err.message;
        }
      });

      signupBtn.addEventListener("click", async () => {
        try {
          const res = await fetch(API + "/auth/signup", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              username: username.value.trim(),
              password: password.value,
            }),
          });
          if (!res.ok) {
            const msg = await res.json().catch(() => ({}));
            throw new Error(msg.message || "Signup failed");
          }
          const data = await res.json();
          setToken(data.token, data.username);
          loadTodos();
        } catch (err) {
          authStatus.textContent = err.message;
        }
      });

      if (token) {
        authStatus.textContent = "Signed in";
      } else {
        authStatus.textContent = "Not signed in";
      }
      loadTodos();
    </script>
  </body>
</html>
